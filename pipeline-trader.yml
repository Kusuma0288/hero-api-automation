parameters:
  - name: triggerEnv
    displayName: Run Environment
    type: string
    default: all
    values:
      - uat
      - test
      - prod
      - all

trigger:
  none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: MobileAuto-UAT
  - name: trader-uat-lastFailCount
    value: $[variables.Trader_UAT_LastFailCount]

stages:
  - stage: Auto
    # Job schedules are managed --> https://wowonline.visualstudio.com/Mobile/_apps/hub/ms.vss-ciworkflow.build-ci-hub?_a=edit-build-definition&id=1603&view=Tab_Triggers
    jobs:
      - job: Prod_Trader
        steps:
          - template: pipelines/templates/base-template.yml
            parameters:
              TestRunTitle: Prod_Trader Automation Run Report
              Profile: Prod_trader
              RunEnv: prod
              Service: trader
        condition: and(succeededOrFailed(), eq('${{ parameters.triggerEnv }}', 'all'))

      - job: Uat_Trader
        steps:
          - script: |
              echo "Setting up delay for the job"
              sleep 10m
              echo ${{ parameters.triggerEnv }}
          - template: pipelines/templates/base-template.yml
            parameters:
              TestRunTitle: Uat_Trader Automation Run Report
              Profile: regression_trader
              RunEnv: uat
              Service: trader
        condition: and(succeededOrFailed(), eq('${{ parameters.triggerEnv }}', 'all'))

      - job: Test_Trader
        steps:
          - script: |
              echo "Setting up delay for the job"
              sleep 10m
              echo ${{ parameters.triggerEnv }}
          - template: pipelines/templates/base-template.yml
            parameters:
              TestRunTitle: Test_Trader Automation Run Report
              Profile: regression_trader
              RunEnv: test
              Service: trader
        condition: and(succeededOrFailed(), eq('${{ parameters.triggerEnv }}', 'all'))

  - stage: Manual

    jobs:
      - job: Manual
        variables:
          ${{ if eq(parameters.triggerEnv, 'prod') }}:
            TriggeredProfile: Prod_trader
          ${{ if eq(parameters.triggerEnv, 'uat') }}:
            TriggeredProfile: regression_trader
          ${{ if eq(parameters.triggerEnv, 'test') }}:
            TriggeredProfile: regression_trader
        displayName: Manual Automation Run
        steps:
          - script: |
              echo ${{ parameters.triggerEnv }}
          - template: pipelines/templates/base-template.yml
            parameters:
              TestRunTitle: Trader Automation Run Report
              Profile: ${{variables.TriggeredProfile}}
              RunEnv: ${{ parameters.triggerEnv }}
              Service: trader
        condition: and(succeededOrFailed(), ne('${{ parameters.triggerEnv }}', 'all'))